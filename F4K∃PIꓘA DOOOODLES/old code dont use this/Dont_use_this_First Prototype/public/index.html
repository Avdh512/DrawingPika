<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Photo Blog</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for theming */
        :root {
            /* Light Mode Colors */
            --bg-gradient-start: #e0e7ee;
            --bg-gradient-end: #f0f4f8;
            --text-color: #333333;
            --card-bg: #ffffff;
            --header-bg: #ffffff;
            --navbar-bg: #ffffff;
            --primary-blue: #1e90ff;
            --primary-blue-dark: #007bff;
            --primary-green: #28a745;
            --primary-red: #dc3545;
            --primary-red-dark: #c82333;
            --medium-gray-text: #666666;
            --light-border: #e0e0e0;
            --upload-area-bg: #f8fbfd;
            --upload-area-hover-bg: #f0f6fa;
            --upload-area-dragover-bg: #e6f0f5;
            --blog-date-heading-color: #1e90ff;
            --blog-entry-border: #f0f0f0;
            --blog-description-bg: #fdfdfd;
            --blog-entry-separator-bg: #e0e0e0;
            --blog-date-separator-gradient-start: transparent;
            --blog-date-separator-gradient-end: #b0c4de;
            --calendar-day-bg: #f5f5f5;
            --calendar-day-hover-bg: #e8e8e8;
            --json-viewer-bg: #f0f0f0;
            --json-viewer-border: #e0e0e0;
            --spinner-color: #1e90ff;
            --shadow-light: rgba(0, 0, 0, 0.08);
            --shadow-medium: rgba(0, 0, 0, 0.12);
            --shadow-heavy: rgba(0, 0, 0, 0.15);
            --shadow-button: rgba(30, 144, 255, 0.25);
            --shadow-button-hover: rgba(0, 123, 255, 0.35);
            --shadow-button-green: rgba(40, 167, 69, 0.3);
            --shadow-button-red: rgba(220, 53, 69, 0.25);
            --shadow-button-red-hover: rgba(200, 35, 51, 0.35);
            --shadow-modal: rgba(0, 0, 0, 0.7);
            --modal-bg: rgba(0, 0, 0, 0.95);
            --modal-info-gradient: rgba(0, 0, 0, 0.8);
            --modal-close-hover: #ff4d4d;
        }

        /* Dark Mode Colors */
        body.dark-mode {
            --bg-gradient-start: #2c3e50;
            --bg-gradient-end: #1a252f;
            --text-color: #e0e0e0;
            --card-bg: #34495e;
            --header-bg: #34495e;
            --navbar-bg: #34495e;
            --primary-blue: #61afef; /* Lighter blue for dark mode */
            --primary-blue-dark: #3e8ed0;
            --primary-green: #2ecc71;
            --primary-red: #e74c3c;
            --primary-red-dark: #c0392b;
            --medium-gray-text: #a0a0a0;
            --light-border: #4a627a;
            --upload-area-bg: #40556b;
            --upload-area-hover-bg: #4a627a;
            --upload-area-dragover-bg: #556c83;
            --blog-date-heading-color: #61afef;
            --blog-entry-border: #4a627a;
            --blog-description-bg: #3e5369;
            --blog-entry-separator-bg: #4a627a;
            --blog-date-separator-gradient-start: transparent;
            --blog-date-separator-gradient-end: #3e5369;
            --calendar-day-bg: #4a627a;
            --calendar-day-hover-bg: #556c83;
            --json-viewer-bg: #3e5369;
            --json-viewer-border: #4a627a;
            --spinner-color: #61afef;
            --shadow-light: rgba(0, 0, 0, 0.2);
            --shadow-medium: rgba(0, 0, 0, 0.3);
            --shadow-heavy: rgba(0, 0, 0, 0.4);
            --shadow-button: rgba(97, 175, 239, 0.25);
            --shadow-button-hover: rgba(62, 142, 208, 0.35);
            --shadow-button-green: rgba(46, 204, 113, 0.3);
            --shadow-button-red: rgba(231, 76, 60, 0.25);
            --shadow-button-red-hover: rgba(192, 57, 43, 0.35);
            --shadow-modal: rgba(0, 0, 0, 0.8);
            --modal-bg: rgba(0, 0, 0, 0.98);
            --modal-info-gradient: rgba(0, 0, 0, 0.9);
            --modal-close-hover: #ff6b6b;
        }

        /* General Reset & Body Styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            color: var(--text-color);
            line-height: 1.6;
            transition: background 0.5s ease, color 0.5s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 25px;
            padding-top: 120px; /* Add padding to account for fixed navbar */
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 50px;
            background: var(--header-bg);
            border-radius: 25px;
            padding: 35px;
            box-shadow: 0 18px 40px var(--shadow-light);
            transition: background 0.5s ease, box-shadow 0.5s ease;
        }

        .header h1 {
            font-size: 3.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
        }

        .datetime-display {
            font-size: 1.3rem;
            color: var(--medium-gray-text);
            font-weight: 500;
        }

        /* Navigation Bar - Top Fixed */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--navbar-bg);
            box-shadow: 0 5px 20px var(--shadow-light);
            z-index: 1000; /* Ensure it's above other content */
            padding: 20px 0; /* Vertical padding */
            transition: background 0.5s ease, box-shadow 0.5s ease;
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 25px; /* Horizontal padding for alignment */
        }

        .nav-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 14px 25px;
            font-size: 1.05rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 6px 20px var(--shadow-button);
        }

        .nav-btn:hover {
            transform: translateY(-3px);
            background: var(--primary-blue-dark);
            box-shadow: 0 10px 25px var(--shadow-button-hover);
        }

        .nav-btn.active {
            background: var(--primary-green);
            box-shadow: 0 6px 20px var(--shadow-button-green);
        }

        /* Dark Mode Toggle - Top Right Corner */
        #darkModeContainer {
            position: fixed;
            top: 25px;
            right: 25px;
            z-index: 1001; /* Above navbar */
        }

        #darkModeToggle {
            background: var(--card-bg);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 5px 15px var(--shadow-light);
            transition: all 0.3s ease;
            color: var(--text-color); /* Icon color */
        }

        #darkModeToggle:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px var(--shadow-medium);
        }

        /* Section containers */
        .section {
            display: none;
            animation: fadeIn 0.6s ease-in-out;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(25px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .content-card {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 45px;
            box-shadow: 0 18px 40px var(--shadow-light);
            margin-bottom: 40px;
            transition: background 0.5s ease, box-shadow 0.5s ease;
        }

        .section-title {
            font-size: 2.4rem;
            font-weight: 700;
            margin-bottom: 35px;
            color: var(--text-color);
            text-align: center;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Forms (Upload & Edit) */
        .upload-form, .edit-form {
            display: grid;
            gap: 25px;
            margin-bottom: 35px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--medium-gray-text);
            font-size: 1.05rem;
        }

        .form-input, .form-select {
            padding: 14px;
            border: 1px solid var(--light-border);
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--blog-description-bg); /* Using blog-description-bg for form inputs */
            color: var(--text-color);
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(30, 144, 255, 0.15);
            background: var(--card-bg);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--primary-blue);
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--upload-area-bg);
        }

        .upload-area:hover {
            border-color: var(--primary-green);
            background: var(--upload-area-hover-bg);
            transform: translateY(-3px);
        }

        .upload-area.dragover {
            border-color: var(--primary-green);
            background: var(--upload-area-dragover-bg);
            transform: scale(1.01);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--primary-blue);
        }

        .upload-text {
            font-size: 1.3rem;
            color: var(--text-color);
            margin-bottom: 12px;
            font-weight: 500;
        }

        .upload-subtext {
            color: var(--medium-gray-text);
            font-size: 0.95rem;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .action-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 30px;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            box-shadow: 0 6px 20px var(--shadow-button);
        }

        .action-btn:hover {
            transform: translateY(-3px);
            background: var(--primary-blue-dark);
            box-shadow: 0 10px 25px var(--shadow-button-hover);
        }

        .action-btn:disabled {
            background: var(--light-border);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Blog-style Gallery */
        .blog-gallery {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* New style for subtle date heading */
        .blog-date-heading {
            font-size: 2.2rem; /* Larger date heading */
            font-weight: 700;
            color: var(--blog-date-heading-color);
            text-align: center;
            margin: 60px 0 30px 0;
        }

        .blog-entry {
            background: var(--card-bg);
            border-radius: 20px;
            margin-bottom: 40px;
            overflow: hidden;
            box-shadow: 0 10px 30px var(--shadow-light);
            transition: all 0.3s ease;
        }

        .blog-entry:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 45px var(--shadow-medium);
        }

        .blog-entry-header {
            padding: 30px 35px 20px;
            border-bottom: 1px solid var(--blog-entry-border);
        }

        .blog-entry-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-color);
            margin: 0 0 10px 0;
        }

        .blog-entry-meta {
            color: var(--medium-gray-text);
            font-size: 1.05rem;
            font-weight: 500;
            display: block;
            margin-top: 8px;
        }

        .blog-entry-time {
            color: var(--primary-blue);
            font-weight: 600;
        }

        .blog-entry-location {
            color: #ff8c00; /* Specific orange, can be themed if needed */
            font-weight: 600;
        }

        .blog-image-container {
            position: relative;
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            background: var(--upload-area-bg);
        }

        .blog-image-container:hover {
            opacity: 1;
        }

        .blog-image {
            max-width: 100%;
            max-height: 600px;
            width: auto;
            height: auto;
            display: block;
            transition: transform 0.3s ease; 
            border-radius: 0;
            object-fit: contain;
        }

        .blog-image-container:hover .blog-image {
            transform: scale(1.02);
        }

        .blog-description {
            padding: 30px 35px 35px;
            font-size: 1.15rem;
            line-height: 1.8;
            color: var(--text-color);
            background: var(--blog-description-bg);
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
        }

        .blog-description p {
            margin: 0 0 18px 0;
        }

        .blog-description p:last-child {
            margin-bottom: 0;
        }

        /* Separators */
        .blog-entry-separator {
            height: 1px;
            background: var(--blog-entry-separator-bg);
            margin: 30px auto;
            width: 80%;
            border: none;
        }

        .blog-date-separator {
            height: 3px;
            background: linear-gradient(90deg, var(--blog-date-separator-gradient-start), var(--blog-date-separator-gradient-end), var(--blog-date-separator-gradient-start));
            margin: 80px 0;
            border: none;
        }

        /* Full Screen Modal (for Gallery Grid) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-bg);
            transition: background 0.5s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.4s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            max-width: 95vw;
            max-height: 95vh;
            object-fit: contain;
            border-radius: 15px;
            box-shadow: 0 20px 50px var(--shadow-modal);
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 25px;
            color: white;
            font-size: 3rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .modal-close:hover {
            color: var(--modal-close-hover);
            transform: scale(1.15);
        }

        .modal-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, var(--modal-info-gradient));
            color: white;
            padding: 25px;
            text-align: center;
        }

        .modal-title {
            font-size: 1.6rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .modal-date {
            font-size: 1rem;
            opacity: 0.95;
        }

        /* Grid Gallery */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px; /* Made closer */
            margin-top: 25px;
        }

        .gallery-item {
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 12px 30px var(--shadow-light);
            transition: all 0.3s ease;
            background: var(--card-bg);
            cursor: pointer;
            position: relative;
            /* Added min-height to ensure consistent card size */
            min-height: 250px; 
            display: flex; /* Use flexbox to center image vertically */
            align-items: center;
            justify-content: center;
        }

        .gallery-item:hover {
            transform: translateY(-7px);
            box-shadow: 0 18px 45px var(--shadow-medium);
        }

        .gallery-item img {
            width: 100%;
            /* Changed from fixed height and cover to auto height and contain */
            height: auto; 
            max-height: 250px; /* Limit max height to prevent excessively large images */
            object-fit: contain; /* Show whole image, letterbox if aspect ratio differs */
            transition: transform 0.3s ease; 
        }

        .gallery-item-info {
            padding: 0px; /* Removed padding to make images closer */
        }

        .gallery-item-name, .gallery-item-date {
            display: none; /* Explicitly hide name and date in gallery grid */
        }

        /* Calendar Styles */
        .calendar {
            width: 100%;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .calendar-nav {
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 18px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 1.05rem;
        }

        .calendar-nav:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
        }

        .calendar-month {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--text-color);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            padding: 15px 5px;
            color: var(--medium-gray-text);
            font-size: 1rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 1.05rem;
            background-color: var(--calendar-day-bg);
            color: var(--text-color);
        }

        .calendar-day:hover {
            transform: scale(1.08);
            background-color: var(--calendar-day-hover-bg);
        }

        .calendar-day.empty {
            background-color: transparent;
            color: var(--light-border);
            cursor: default;
        }

        .calendar-day.has-upload {
            background: var(--primary-green);
            color: white;
            box-shadow: 0 6px 15px var(--shadow-button-green);
        }

        .calendar-day.selected {
            background: var(--primary-red);
            color: white;
            box-shadow: 0 6px 15px var(--shadow-button-red);
        }

        .calendar-day.today {
            border: 3px solid var(--primary-blue);
            font-weight: 700;
        }

        /* Status Messages */
        .status-message {
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 500;
            font-size: 1.05rem;
            border: 1px solid;
        }

        .status-success {
            background: #e6ffe6;
            color: var(--primary-green);
            border-color: var(--primary-green);
        }

        .status-error {
            background: #ffe6e6;
            color: var(--primary-red);
            border-color: var(--primary-red);
        }

        /* JSON Viewer */
        .json-viewer {
            background: var(--json-viewer-bg);
            border-radius: 15px;
            padding: 25px;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--json-viewer-border);
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--text-color);
        }

        /* Delete section specific styles */
        .delete-options {
            display: flex;
            flex-direction: column;
            gap: 25px;
            align-items: center;
        }

        .delete-btn {
            background: var(--primary-red);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 30px;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px var(--shadow-button-red);
        }

        .delete-btn:hover {
            transform: translateY(-3px);
            background: var(--primary-red-dark);
            box-shadow: 0 10px 25px var(--shadow-button-red-hover);
        }

        .delete-btn:active {
            transform: translateY(0);
            box-shadow: 0 3px 10px var(--shadow-button-red);
        }

        .delete-info {
            font-size: 1rem;
            color: var(--medium-gray-text);
            text-align: center;
            margin-top: 8px;
        }
        
        .delete-gallery-item {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary-red);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0;
            pointer-events: none;
            z-index: 5;
        }

        .gallery-item:hover .delete-gallery-item {
            opacity: 1;
            pointer-events: all;
        }

        .delete-gallery-item:hover {
            background: var(--primary-red-dark);
            transform: scale(1.15);
        }

        /* Edit Section Specific Styles */
        .edit-image-preview {
            max-width: 100%;
            max-height: 400px;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid var(--light-border);
            background-color: var(--calendar-day-bg);
            display: block;
            margin-left: auto;
            margin-right: auto;
            transition: transform 0.3s ease; 
        }

        /* Loading spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--spinner-color);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .container {
                padding-top: 100px; /* Adjust for smaller fixed navbar on mobile */
            }

            .header h1 {
                font-size: 2.2rem;
            }
            
            .container {
                padding: 15px;
            }

            .nav-buttons {
                flex-direction: column;
                gap: 12px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .blog-image {
                height: auto;
            }

            .gallery-grid {
                grid-template-columns: 1fr;
            }

            .content-card {
                padding: 30px;
            }

            .section-title {
                font-size: 2rem;
            }

            .blog-date-heading {
                font-size: 1.6rem;
            }

            #darkModeContainer {
                top: 15px;
                right: 15px;
                width: 40px;
                height: 40px;
            }

            #darkModeToggle {
                width: 40px;
                height: 40px;
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Top Fixed Navigation Bar -->
    <div class="navbar">
        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showSection('upload')">
                üì§ Upload & Create Post
            </button>
            <button class="nav-btn" onclick="showSection('edit-photos')">
                ‚úèÔ∏è Edit Photos
            </button>
            <button class="nav-btn" onclick="showSection('blog-gallery')">
                üìñ Photo Blog
            </button>
            <button class="nav-btn" onclick="showSection('grid-gallery')">
                üñºÔ∏è Gallery Grid
            </button>
            <button class="nav-btn" onclick="showSection('calendar')">
                üìÖ Calendar View
            </button>
            <button class="nav-btn" onclick="showSection('data')">
                üìÅ Data & Export
            </button>
            <button class="nav-btn" onclick="showSection('delete-data')">
                üóëÔ∏è Delete Data
            </button>
        </div>
    </div>

    <!-- Dark Mode Toggle - Top Right Corner -->
    <div id="darkModeContainer">
        <button id="darkModeToggle" onclick="toggleDarkMode()">
            ‚òÄÔ∏è <!-- Default to sun icon (light mode) -->
        </button>
    </div>

    <div class="container">
        <div class="header">
            <h1>Professional Photo Blog</h1>
            <div class="datetime-display" id="datetime"></div>
        </div>

        <!-- Upload Section -->
        <div id="upload" class="section active">
            <div class="content-card">
                <h2 class="section-title">üì§ Create New Photo Post</h2>
                
                <div class="upload-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="photoTitle">üìù Photo Title/Name <span style="color: red;">*</span></label>
                            <input type="text" id="photoTitle" class="form-input" placeholder="Enter a custom name for your photo..." required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="photoDate">üìÖ Photo Date <span style="color: red;">*</span></label>
                            <input type="date" id="photoDate" class="form-input" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="photoTime">üïí Photo Time <span style="color: red;">*</span></label>
                            <input type="time" id="photoTime" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="photoLocation">üìç Location (Optional)</label>
                            <input type="text" id="photoLocation" class="form-input" placeholder="Where was this taken?">
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label" for="photoDescription">üìñ Description/Story</label>
                        <textarea id="photoDescription" class="form-input form-textarea" placeholder="Tell the story behind this photo... What was happening? How did you feel? Any memories you want to capture?"></textarea>
                    </div>
                </div>

                <div id="statusMessage"></div>
                
                <div class="upload-area" onclick="document.getElementById('fileInput').click()" 
                     ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <div class="upload-icon">üì∏</div>
                    <div class="upload-text">Click to select photos or drag & drop</div>
                    <div class="upload-subtext">Supports JPG, PNG, GIF ‚Ä¢ Multiple files allowed</div>
                    <input type="file" id="fileInput" class="file-input" multiple accept="image/*" onchange="handleFileSelect(event)">
                </div>

                <div id="selectedFilesPreview" style="margin-top: 20px; padding: 15px; border: 1px dashed var(--light-border); border-radius: 10px; background: var(--upload-area-bg); display: none; text-align: center; color: var(--text-color);">
                    <strong>Selected Files:</strong><br>
                    <ul id="fileList" style="list-style-type: none; padding: 0; margin-top: 10px;"></ul>
                </div>

                <button class="action-btn" id="submitUploadBtn" onclick="uploadPost()" disabled>
                    üöÄ Submit Photo Post
                </button>
            </div>
        </div>

        <!-- Edit Photos Section -->
        <div id="edit-photos" class="section">
            <div class="content-card">
                <h2 class="section-title">‚úèÔ∏è Edit Photo Details</h2>
                
                <div class="form-group full-width" style="margin-bottom: 30px;">
                    <label class="form-label" for="editPhotoSelect">Select Photo to Edit</label>
                    <select id="editPhotoSelect" class="form-select" onchange="onPhotoSelectedForEdit(event)">
                        <option value="">-- Select a photo --</option>
                    </select>
                </div>

                <!-- Added cache-busting to editImagePreview src -->
                <img id="editImagePreview" class="edit-image-preview" src="" alt="Selected Photo Preview" style="display: none;">
                
                <div class="edit-form" id="editFormFields" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="editPhotoTitle">üìù Photo Title/Name <span style="color: red;">*</span></label>
                            <input type="text" id="editPhotoTitle" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="editPhotoDate">üìÖ Photo Date <span style="color: red;">*</span></label>
                            <input type="date" id="editPhotoDate" class="form-input" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="editPhotoTime">üïí Photo Time <span style="color: red;">*</span></label>
                            <input type="time" id="editPhotoTime" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="editPhotoLocation">üìç Location (Optional)</label>
                            <input type="text" id="editPhotoLocation" class="form-input">
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label" for="editPhotoDescription">üìñ Description/Story</label>
                        <textarea id="editPhotoDescription" class="form-input form-textarea"></textarea>
                    </div>

                    <div class="form-group full-width" style="text-align: center; margin-top: 20px;">
                        <button class="action-btn" id="rotateImageBtn" onclick="rotateImage()" style="background: #f39c12;">
                            üîÑ Rotate Image (90¬∞)
                        </button>
                    </div>

                    <button class="action-btn" id="saveEditBtn" onclick="saveEditedPhoto()">
                        üíæ Save Changes
                    </button>
                </div>
                <div id="editStatusMessage"></div>
            </div>
        </div>


        <!-- Blog Gallery Section -->
        <div id="blog-gallery" class="section">
            <div class="content-card">
                <h2 class="section-title">üìñ Photo Blog</h2>
                <div class="blog-gallery" id="blogGallery"></div>
            </div>
        </div>

        <!-- Grid Gallery Section -->
        <div id="grid-gallery" class="section">
            <div class="content-card">
                <h2 class="section-title">üñºÔ∏è Gallery Grid</h2>
                <div class="gallery-grid" id="galleryGrid"></div>
            </div>
        </div>

        <!-- Calendar Section -->
        <div id="calendar" class="section">
            <div class="content-card">
                <h2 class="section-title">üìÖ Calendar View</h2>
                <div class="calendar">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="previousMonth()">‚Äπ Previous</button>
                        <div class="calendar-month" id="currentMonth"></div>
                        <button class="calendar-nav" onclick="nextMonth()">Next ‚Ä∫</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>
        </div>

        <!-- Data Section -->
        <div id="data" class="section">
            <div class="content-card">
                <h2 class="section-title">üìÅ Data & Export</h2>
                <div style="margin-bottom: 20px; text-align: center;">
                    <button class="action-btn" onclick="downloadJSON()">üíæ Download JSON Data</button>
                    <button class="action-btn" onclick="refreshData()" style="background: #f39c12;">üîÑ Refresh Data</button>
                </div>
                <div class="json-viewer" id="jsonViewer"></div>
            </div>
        </div>

        <!-- Delete Data Section -->
        <div id="delete-data" class="section">
            <div class="content-card">
                <h2 class="section-title">üóëÔ∏è Delete Photos & Data</h2>
                <div class="delete-options">
                    <button class="delete-btn" onclick="deleteAllPhotos()">Permanently Delete All Photos</button>
                    <div class="delete-info">This will remove all uploaded photos from the server's photos folder. This action cannot be undone.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Full Screen Modal -->
    <div id="imageModal" class="modal" onclick="closeModal()">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <!-- Added cache-busting to modalImage src -->
        <img class="modal-content" id="modalImage">
        <div class="modal-info" id="modalInfo"></div>
    </div>
        
    <script>
        // Global variables
        let currentDate = new Date();
        let uploadedFiles = {}; // Will be loaded from server, organized by date
        let allPhotosFlat = []; // Flat array of all photos for easier lookup
        let selectedDate = null;
        let currentSection = 'upload';
        let filesToUpload = []; // Stores files selected for upload

        // For editing
        let currentlyEditingPhotoId = null;
        let currentEditPhotoRotation = 0; // Stores the current rotation for the photo being edited

        // Initialize the application when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', init);

        /**
         * Initializes the application
         */
        async function init() {
            updateDateTime();
            await loadPhotosFromServer(); // Load existing photos from server
            renderCalendar();
            renderBlogGallery();
            renderGridGallery();
            updateJsonViewer();
            renderEditPhotoSelection(); // Populate the dropdown for editing

            // Set default date/time for upload form to current date/time
            const now = new Date();
            document.getElementById('photoDate').value = now.toISOString().split('T')[0];
            document.getElementById('photoTime').value = now.toTimeString().slice(0, 5);
            
            // Update datetime display every second
            setInterval(updateDateTime, 1000);

            // Apply dark mode preference if saved and update toggle icon
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').innerHTML = 'üåô';
            } else {
                localStorage.setItem('darkMode', 'disabled'); // Ensure it's explicitly set for light mode
                document.getElementById('darkModeToggle').innerHTML = '‚òÄÔ∏è';
            }

            // Add event listeners to check for form validity for upload button
            document.getElementById('photoTitle').addEventListener('input', checkUploadFormValidity);
            document.getElementById('photoDate').addEventListener('input', checkUploadFormValidity);
            document.getElementById('photoTime').addEventListener('input', checkUploadFormValidity);
        }

        /**
         * Checks if the upload form is valid to enable the submit button
         */
        function checkUploadFormValidity() {
            const title = document.getElementById('photoTitle').value;
            const date = document.getElementById('photoDate').value;
            const time = document.getElementById('photoTime').value;
            const submitBtn = document.getElementById('submitUploadBtn');

            if (title.trim() !== '' && date.trim() !== '' && time.trim() !== '' && filesToUpload.length > 0) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }

        /**
         * Toggles dark mode on/off
         */
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('darkMode', 'enabled');
                darkModeToggle.innerHTML = 'üåô';
            } else {
                localStorage.setItem('darkMode', 'disabled');
                darkModeToggle.innerHTML = '‚òÄÔ∏è';
            }
        }

        /**
         * Load photos from server and flatten them for easier access
         */
        async function loadPhotosFromServer() {
            try {
                const response = await fetch(`${window.location.origin}/api/photos`);
                if (response.ok) {
                    const data = await response.json();
                    uploadedFiles = data.photos || {};
                    allPhotosFlat = [];
                    // Flatten the uploadedFiles object into an array
                    Object.values(uploadedFiles).forEach(dateFiles => {
                        allPhotosFlat = allPhotosFlat.concat(dateFiles);
                    });
                    console.log("Photos loaded from server:", uploadedFiles); // Debugging
                } else {
                    console.log('No photos found on server or error occurred');
                    uploadedFiles = {};
                    allPhotosFlat = [];
                }
            } catch (error) {
                console.error('Error loading photos from server:', error);
                uploadedFiles = {};
                allPhotosFlat = [];
            }
        }

        /**
         * Refresh data from server
         */
        async function refreshData() {
            showStatus('Refreshing data from server...', 'success');
            await loadPhotosFromServer();
            renderCalendar();
            renderBlogGallery();
            renderGridGallery();
            updateJsonViewer();
            renderEditPhotoSelection(); // Re-populate edit dropdown
            showStatus('Data refreshed successfully!', 'success');
        }

        /**
         * Shows the selected section and updates navigation button active state
         */
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Deactivate all navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find the button corresponding to the sectionId and activate it
            const targetButton = Array.from(document.querySelectorAll('.nav-btn')).find(btn => 
                btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(`'${sectionId}'`)
            );
            if (targetButton) {
                targetButton.classList.add('active');
            }

            // Show the selected section
            document.getElementById(sectionId).classList.add('active');
            currentSection = sectionId;

            // Specific refresh for edit section when shown
            if (sectionId === 'edit-photos') {
                renderEditPhotoSelection();
            }
        }

        /**
         * Updates the current date and time display in the header
         */
        function updateDateTime() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('datetime').textContent = now.toLocaleDateString('en-US', options);
        }

        /**
         * Handles file selection from the input element, stores files, and updates preview
         */
        function handleFileSelect(event) {
            filesToUpload = Array.from(event.target.files);
            const fileListElement = document.getElementById('fileList');
            const selectedFilesPreview = document.getElementById('selectedFilesPreview');
            fileListElement.innerHTML = ''; // Clear previous list

            if (filesToUpload.length > 0) {
                selectedFilesPreview.style.display = 'block';
                filesToUpload.forEach(file => {
                    const listItem = document.createElement('li');
                    listItem.textContent = file.name;
                    fileListElement.appendChild(listItem);
                });
            } else {
                selectedFilesPreview.style.display = 'none';
            }
            checkUploadFormValidity(); // Check validity after file selection
        }

        /**
         * Handles drag over event for the upload area
         */
        function handleDragOver(event) {
            event.preventDefault();
            document.querySelector('.upload-area').classList.add('dragover');
        }

        /**
         * Handles drag leave event for the upload area
         */
        function handleDragLeave(event) {
            event.preventDefault();
            document.querySelector('.upload-area').classList.remove('dragover');
        }

        /**
         * Handles drop event for the upload area
         */
        function handleDrop(event) {
            event.preventDefault();
            document.querySelector('.upload-area').classList.remove('dragover');
            filesToUpload = Array.from(event.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            handleFileSelect({ target: { files: filesToUpload } }); // Reuse handleFileSelect to update preview
        }

        /**
         * Processes and uploads selected image files to server when submit button is clicked
         */
        async function uploadPost() {
            if (filesToUpload.length === 0) {
                showStatus('No image files selected for upload.', 'error');
                return;
            }

            // Get metadata from the upload form
            const title = document.getElementById('photoTitle').value;
            const date = document.getElementById('photoDate').value;
            const time = document.getElementById('photoTime').value;
            const location = document.getElementById('photoLocation').value;
            const description = document.getElementById('photoDescription').value;

            if (!title.trim() || !date || !time) {
                showStatus('Please fill in Photo Title, Date, and Time.', 'error');
                return;
            }

            const uploadBtn = document.getElementById('submitUploadBtn');
            const originalText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<span class="spinner"></span>Uploading...';
            uploadBtn.disabled = true;

            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < filesToUpload.length; i++) {
                try {
                    const file = filesToUpload[i];
                    const formData = new FormData();
                    
                    // Create unique filename with title and index if multiple files
                    const fileName = filesToUpload.length > 1 ? `${title}_${i + 1}` : title;
                    formData.append('image', file);
                    formData.append('name', fileName); // Pass the user-provided name
                    formData.append('date', date);
                    formData.append('time', time);
                    formData.append('location', location);
                    formData.append('description', description);

                    const response = await fetch(`${window.location.origin}/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        successCount++;
                    } else {
                        errorCount++;
                        const errorData = await response.json();
                        console.error('Upload error:', errorData);
                    }
                } catch (error) {
                    errorCount++;
                    console.error('Upload error:', error);
                }
            }

            // Reset upload button
            uploadBtn.innerHTML = originalText;
            uploadBtn.disabled = false; // Will be re-enabled by checkUploadFormValidity if conditions met

            if (successCount > 0) {
                showStatus(`Successfully uploaded ${successCount} photo(s)!`, 'success');
                
                // Clear form and selected files
                document.getElementById('photoTitle').value = '';
                document.getElementById('photoLocation').value = '';
                document.getElementById('photoDescription').value = '';
                document.getElementById('fileInput').value = '';
                filesToUpload = []; // Clear stored files
                document.getElementById('selectedFilesPreview').style.display = 'none';
                document.getElementById('fileList').innerHTML = '';
                checkUploadFormValidity(); // Re-check to disable button

                // Refresh data from server
                await loadPhotosFromServer();
                renderCalendar();
                renderBlogGallery();
                renderGridGallery();
                updateJsonViewer();
                renderEditPhotoSelection(); // Re-populate edit dropdown
            }

            if (errorCount > 0) {
                showStatus(`${errorCount} file(s) failed to upload. ${successCount > 0 ? `${successCount} uploaded successfully.` : ''}`, 'error');
            }
        }

        /**
         * Displays a status message to the user
         */
        function showStatus(message, type, targetElementId = 'statusMessage') {
            const statusDiv = document.getElementById(targetElementId);
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 4000);
        }

        /**
         * Downloads JSON data of all photos
         */
        function downloadJSON() {
            const dataStr = JSON.stringify({
                totalPhotos: allPhotosFlat.length,
                photosByDate: uploadedFiles // Keep original structure for export
            }, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `photo-blog-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus('JSON data downloaded successfully!', 'success');
        }

        /**
         * Renders the blog-style gallery section
         */
        function renderBlogGallery() {
            const blogContainer = document.getElementById('blogGallery');
            blogContainer.innerHTML = '';
            
            let filesToShow = [];
            
            if (selectedDate && uploadedFiles[selectedDate]) {
                filesToShow = uploadedFiles[selectedDate];
            } else {
                filesToShow = [...allPhotosFlat]; // Use a copy
            }
            
            // Sort all files by photoDateTime in reverse chronological order (newest first)
            filesToShow.sort((a, b) => new Date(b.photoDateTime) - new Date(a.photoDateTime));
            
            if (filesToShow.length === 0) {
                blogContainer.innerHTML = '<div style="text-align: center; color: var(--medium-gray-text); font-style: italic; padding: 60px; font-size: 1.2rem;">üì∏ No photos uploaded yet.<br><br>Click "Upload & Create Post" to start your photo blog!</div>';
                return;
            }

            let lastDate = null; // To track date changes for subtle date headings

            filesToShow.forEach((file, fileIndex) => {
                const photoDateObj = new Date(file.photoDateTime);
                const currentDateKey = photoDateObj.toISOString().split('T')[0];

                // Add a subtle date heading if the date changes
                if (currentDateKey !== lastDate) {
                    const dateHeading = document.createElement('h3');
                    dateHeading.className = 'blog-date-heading';
                    dateHeading.textContent = photoDateObj.toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    blogContainer.appendChild(dateHeading);
                    lastDate = currentDateKey;
                }

                const blogEntry = document.createElement('div');
                blogEntry.className = 'blog-entry';
                
                const formattedTime = photoDateObj.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // --- Cache-busting: Use lastModified timestamp for image URL ---
                const cacheBuster = file.lastModified ? new Date(file.lastModified).getTime() : new Date().getTime();
                const imageUrl = `${window.location.origin}/photos/${file.fileName}?_=${cacheBuster}`;
                // --- End Cache-busting ---

                // Create the blog entry HTML
                let entryHTML = `
                    <div class="blog-entry-header">
                        <h3 class="blog-entry-title">${file.title}</h3>
                        <div class="blog-entry-meta">
                            <span class="blog-entry-time">${formattedTime}</span>
                            ${file.location ? `<span> ‚Ä¢ </span><span class="blog-entry-location">${file.location}</span>` : ''}
                        </div>
                    </div>
                `;
                
                // Add description if it exists (before image)
                if (file.description && file.description.trim()) {
                    const descriptionParts = file.description.split('\n').filter(p => p.trim());
                    if (descriptionParts.length > 0) {
                        // Take first part of description before image
                        entryHTML += `<div class="blog-description"><p>${descriptionParts[0].trim()}</p></div>`;
                    }
                }

                // Add image (no rotation CSS needed since image is physically rotated)
                entryHTML += `
                    <div class="blog-image-container">
                        <img src="${imageUrl}" alt="${file.title}" class="blog-image" loading="lazy">
                    </div>
                `;
                
                // Add remaining description parts after image
                if (file.description && file.description.trim()) {
                    const descriptionParts = file.description.split('\n').filter(p => p.trim());
                    if (descriptionParts.length > 1) {
                        const remainingDescription = descriptionParts.slice(1).map(p => `<p>${p.trim()}</p>`).join('');
                        entryHTML += `<div class="blog-description">${remainingDescription}</div>`;
                    }
                }
                
                blogEntry.innerHTML = entryHTML;
                blogContainer.appendChild(blogEntry);
                
                // Add separator between blog entries (not between date headings)
                if (fileIndex < filesToShow.length - 1) {
                    const nextFileDateKey = new Date(filesToShow[fileIndex + 1].photoDateTime).toISOString().split('T')[0];
                    if (currentDateKey === nextFileDateKey) { // Only add separator if next file is on the same date
                        const separator = document.createElement('hr');
                        separator.className = 'blog-entry-separator';
                        blogContainer.appendChild(separator);
                    } else { // Add a more prominent separator if date changes
                        const separator = document.createElement('hr');
                        separator.className = 'blog-date-separator';
                        blogContainer.appendChild(separator);
                    }
                }
            });
        }

        /**
         * Renders the grid gallery section
         */
        function renderGridGallery() {
            const grid = document.getElementById('galleryGrid');
            grid.innerHTML = '';
            
            let filesToShow = [];
            
            if (selectedDate && uploadedFiles[selectedDate]) {
                filesToShow = uploadedFiles[selectedDate];
            } else {
                filesToShow = [...allPhotosFlat]; // Use a copy
            }
            
            filesToShow.sort((a, b) => new Date(b.photoDateTime) - new Date(a.photoDateTime));
            
            if (filesToShow.length === 0) {
                grid.innerHTML = '<div style="text-align: center; color: var(--medium-gray-text); font-style: italic; grid-column: 1/-1; padding: 60px; font-size: 1.2rem;">üì∏ No photos in gallery yet.<br><br>Upload some photos to see them here!</div>';
                return;
            }

            filesToShow.forEach(file => {
                const item = document.createElement('div');
                item.className = 'gallery-item';
                
                const photoDate = new Date(file.photoDateTime);
                const formattedDate = photoDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // --- Cache-busting: Use lastModified timestamp for image URL ---
                const cacheBuster = file.lastModified ? new Date(file.lastModified).getTime() : new Date().getTime();
                const imageUrl = `${window.location.origin}/photos/${file.fileName}?_=${cacheBuster}`;
                // --- End Cache-busting ---
                
                item.innerHTML = `
                    <img src="${imageUrl}" alt="${file.title}" loading="lazy" onclick="openModal('${imageUrl}', '${file.title}', '${formattedDate}')">
                    <div class="gallery-item-info">
                        <!-- Removed name and date from here as requested -->
                    </div>
                    <button class="delete-gallery-item" onclick="deleteSinglePhoto('${file.fileName}', event)">√ó</button>
                `;
                
                grid.appendChild(item);
            });
            
            if (filesToShow.length === 0) {
                grid.innerHTML = '<div style="text-align: center; color: var(--medium-gray-text); font-style: italic; grid-column: 1/-1; padding: 60px; font-size: 1.2rem;">üì∏ No photos in gallery yet.<br><br>Upload some photos to see them here!</div>';
            }
        }

        /**
         * Opens the full-screen image modal
         */
        function openModal(imageSrc, title, date) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalInfo = document.getElementById('modalInfo');
            
            modal.classList.add('active');
            // The imageSrc passed here already contains the cache-buster from renderGridGallery or renderBlogGallery
            modalImg.src = imageSrc; 
            modalInfo.innerHTML = `
                <div class="modal-title">${title}</div>
                <div class="modal-date">${date}</div>
            `;
            
            document.body.style.overflow = 'hidden';
        }

        /**
         * Closes the full-screen image modal
         */
        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        /**
         * Renders the calendar view
         */
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const today = new Date();
            
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                grid.appendChild(dayHeader);
            });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                grid.appendChild(emptyDay);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                if (uploadedFiles[dateKey] && uploadedFiles[dateKey].length > 0) {
                    dayElement.classList.add('has-upload');
                }
                
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    dayElement.classList.add('today');
                }
                
                if (selectedDate === dateKey) {
                    dayElement.classList.add('selected');
                }
                
                dayElement.onclick = () => selectDate(dateKey);
                grid.appendChild(dayElement);
            }
        }

        /**
         * Selects a date in the calendar
         */
        function selectDate(dateKey) {
            selectedDate = (selectedDate === dateKey) ? null : dateKey;
            renderCalendar();
            renderBlogGallery();
            renderGridGallery();
        }

        /**
         * Navigate to previous month
         */
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        /**
         * Navigate to next month
         */
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        /**
         * Updates the JSON viewer
         */
        function updateJsonViewer() {
            const viewer = document.getElementById('jsonViewer');
            const formattedData = {
                totalPhotos: allPhotosFlat.length,
                photosByDate: uploadedFiles
            };
            
            viewer.textContent = JSON.stringify(formattedData, null, 2);
        }

        /**
         * Populates the dropdown for selecting photos to edit
         */
        function renderEditPhotoSelection() {
            const selectElement = document.getElementById('editPhotoSelect');
            selectElement.innerHTML = '<option value="">-- Select a photo --</option>'; // Reset dropdown

            // Sort photos by title for easier navigation
            const sortedPhotos = [...allPhotosFlat].sort((a, b) => a.title.localeCompare(b.title));

            sortedPhotos.forEach(photo => {
                const option = document.createElement('option');
                option.value = photo.id;
                option.textContent = `${photo.title} (${new Date(photo.photoDateTime).toLocaleDateString()})`;
                selectElement.appendChild(option);
            });

            // Hide edit form fields and preview initially
            document.getElementById('editFormFields').style.display = 'none';
            const editImagePreview = document.getElementById('editImagePreview');
            editImagePreview.style.display = 'none';
            editImagePreview.src = '';
            editImagePreview.style.transform = 'rotate(0deg)'; // Reset rotation
            currentlyEditingPhotoId = null;
            currentEditPhotoRotation = 0; // Reset rotation state
        }

        /**
         * Handles selection of a photo in the edit dropdown
         */
        function onPhotoSelectedForEdit(event) {
            const photoId = event.target.value;
            const editFormFields = document.getElementById('editFormFields');
            const editImagePreview = document.getElementById('editImagePreview');

            if (!photoId) {
                editFormFields.style.display = 'none';
                editImagePreview.style.display = 'none';
                editImagePreview.src = '';
                editImagePreview.style.transform = 'rotate(0deg)'; // Reset rotation
                currentlyEditingPhotoId = null;
                currentEditPhotoRotation = 0; // Reset rotation state
                return;
            }

            const selectedPhoto = allPhotosFlat.find(photo => photo.id === photoId);

            if (selectedPhoto) {
                currentlyEditingPhotoId = photoId;
                document.getElementById('editPhotoTitle').value = selectedPhoto.title;
                
                // Format date and time for input fields
                const dateTime = new Date(selectedPhoto.photoDateTime);
                document.getElementById('editPhotoDate').value = dateTime.toISOString().split('T')[0];
                document.getElementById('editPhotoTime').value = dateTime.toTimeString().slice(0, 5);
                
                document.getElementById('editPhotoLocation').value = selectedPhoto.location || '';
                document.getElementById('editPhotoDescription').value = selectedPhoto.description || '';
                
                // --- Cache-busting for edit preview image ---
                const cacheBuster = selectedPhoto.lastModified ? new Date(selectedPhoto.lastModified).getTime() : new Date().getTime();
                editImagePreview.src = `${window.location.origin}/photos/${selectedPhoto.fileName}?_=${cacheBuster}`;
                // --- End Cache-busting ---

                editImagePreview.style.display = 'block';
                editFormFields.style.display = 'grid'; // Display as grid

                // Reset rotation state since image is now physically correct
                currentEditPhotoRotation = 0;
                editImagePreview.style.transform = 'rotate(0deg)';
                console.log("Selected photo for edit:", selectedPhoto); // Debugging
            } else {
                editFormFields.style.display = 'none';
                editImagePreview.style.display = 'none';
                editImagePreview.src = '';
                editImagePreview.style.transform = 'rotate(0deg)'; // Reset rotation
                currentlyEditingPhotoId = null;
                currentEditPhotoRotation = 0; // Reset rotation state
                showStatus('Selected photo not found.', 'error', 'editStatusMessage');
            }
        }

        /**
         * Rotates the image preview by 90 degrees clockwise.
         */
        function rotateImage() {
            if (!currentlyEditingPhotoId) {
                showStatus('Please select a photo to rotate.', 'error', 'editStatusMessage');
                return;
            }
            currentEditPhotoRotation = (currentEditPhotoRotation + 90) % 360;
            document.getElementById('editImagePreview').style.transform = `rotate(${currentEditPhotoRotation}deg)`;
            console.log("Current preview rotation:", currentEditPhotoRotation); // Debugging
        }

        /**
         * Saves the edited photo metadata
         */
        async function saveEditedPhoto() {
            if (!currentlyEditingPhotoId) {
                showStatus('No photo selected for editing.', 'error', 'editStatusMessage');
                return;
            }

            const title = document.getElementById('editPhotoTitle').value;
            const date = document.getElementById('editPhotoDate').value;
            const time = document.getElementById('editPhotoTime').value;
            const location = document.getElementById('editPhotoLocation').value;
            const description = document.getElementById('editPhotoDescription').value;

            if (!title.trim() || !date || !time) {
                showStatus('Please fill in Photo Title, Date, and Time.', 'error', 'editStatusMessage');
                return;
            }

            const saveBtn = document.getElementById('saveEditBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<span class="spinner"></span>Saving...';
            saveBtn.disabled = true;

            try {
                const response = await fetch(`${window.location.origin}/api/update_metadata`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: currentlyEditingPhotoId,
                        title: title,
                        photoDateTime: `${date}T${time}:00`, // Reconstruct datetime
                        location: location,
                        description: description,
                        rotation: currentEditPhotoRotation // Include rotation
                    })
                });

                if (response.ok) {
                    showStatus('Photo metadata updated successfully!', 'success', 'editStatusMessage');
                    await loadPhotosFromServer(); // Reload all data
                    renderCalendar();
                    renderBlogGallery();
                    renderGridGallery();
                    updateJsonViewer();
                    renderEditPhotoSelection(); // Re-populate dropdown and reset form
                } else {
                    const errorData = await response.json();
                    showStatus('Error updating photo: ' + errorData.error, 'error', 'editStatusMessage');
                }
            } catch (error) {
                showStatus('Error updating photo: ' + error.message, 'error', 'editStatusMessage');
            } finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        /**
         * Deletes a single photo
         */
        async function deleteSinglePhoto(fileName, event) {
            event.stopPropagation();
            // Using a custom modal for confirmation instead of alert/confirm
            const confirmDelete = await showCustomConfirm('Are you sure you want to delete this photo? This cannot be undone.');
            if (!confirmDelete) {
                return;
            }

            try {
                const response = await fetch(`${window.location.origin}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ filename: fileName })
                });

                if (response.ok) {
                    showStatus('Photo deleted successfully!', 'success');
                    await loadPhotosFromServer();
                    renderBlogGallery();
                    renderGridGallery();
                    renderCalendar();
                    updateJsonViewer();
                    renderEditPhotoSelection(); // Re-populate edit dropdown
                } else {
                    const errorData = await response.json();
                    showStatus('Error deleting photo: ' + errorData.error, 'error');
                }
            } catch (error) {
                showStatus('Error deleting photo: ' + error.message, 'error');
            }
        }

        /**
         * Deletes all photos
         */
        async function deleteAllPhotos() {
            // Using a custom modal for confirmation instead of alert/confirm
            const confirmDelete = await showCustomConfirm('Are you sure you want to permanently delete ALL photos? This action cannot be undone.');
            if (!confirmDelete) {
                return;
            }

            try {
                // Get all filenames first
                let allFiles = [];
                Object.values(uploadedFiles).forEach(dateFiles => {
                    allFiles = allFiles.concat(dateFiles);
                });

                let deletedCount = 0;
                for (const file of allFiles) {
                    try {
                        const response = await fetch(`${window.location.origin}/delete`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ filename: file.fileName })
                        });

                        if (response.ok) {
                            deletedCount++;
                        }
                    } catch (error) {
                        console.error('Error deleting file:', file.fileName, error);
                    }
                }

                showStatus(`Successfully deleted ${deletedCount} photos!`, 'success');
                
                // Refresh data
                await loadPhotosFromServer();
                renderCalendar();
                renderBlogGallery();
                renderGridGallery();
                updateJsonViewer();
                renderEditPhotoSelection(); // Re-populate edit dropdown

            } catch (error) {
                showStatus('Error deleting photos: ' + error.message, 'error');
            }
        }

        /**
         * Custom confirmation modal instead of alert/confirm
         */
        function showCustomConfirm(message) {
            return new Promise(resolve => {
                const modalOverlay = document.createElement('div');
                modalOverlay.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;
                    z-index: 9999;
                `;
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: var(--card-bg); padding: 30px; border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; max-width: 400px;
                    color: var(--text-color);
                `;
                const messageParagraph = document.createElement('p');
                messageParagraph.textContent = message;
                messageParagraph.style.cssText = 'margin-bottom: 25px; font-size: 1.1rem;';

                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = 'display: flex; justify-content: center; gap: 15px;';

                const confirmButton = document.createElement('button');
                confirmButton.textContent = 'Yes, Delete';
                confirmButton.style.cssText = `
                    background: var(--primary-red); color: white; border: none; border-radius: 10px;
                    padding: 12px 25px; cursor: pointer; font-weight: 600; font-size: 1rem;
                    transition: all 0.2s ease; box-shadow: 0 4px 15px var(--shadow-button-red);
                `;
                confirmButton.onmouseover = () => confirmButton.style.transform = 'translateY(-2px)';
                confirmButton.onmouseout = () => confirmButton.style.transform = 'translateY(0)';
                confirmButton.onclick = () => {
                    document.body.removeChild(modalOverlay);
                    resolve(true);
                };

                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Cancel';
                cancelButton.style.cssText = `
                    background: var(--medium-gray-text); color: white; border: none; border-radius: 10px;
                    padding: 12px 25px; cursor: pointer; font-weight: 600; font-size: 1rem;
                    transition: all 0.2s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                `;
                cancelButton.onmouseover = () => cancelButton.style.transform = 'translateY(-2px)';
                cancelButton.onmouseout = () => cancelButton.style.transform = 'translateY(0)';
                cancelButton.onclick = () => {
                    document.body.removeChild(modalOverlay);
                    resolve(false);
                };

                buttonContainer.appendChild(confirmButton);
                buttonContainer.appendChild(cancelButton);
                modalContent.appendChild(messageParagraph);
                modalContent.appendChild(buttonContainer);
                modalOverlay.appendChild(modalContent);
                document.body.appendChild(modalOverlay);
            });
        }

        // Modal event listeners for image viewer
        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>
